<!doctype html>
<html>
<head>
<title>CHIME FRB L1 node status</title>

<script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='d3.min.js') }}"></script>

</head>

<body id="thebody">

<style>

.chart rect {
  fill: steelblue;
    stroke: black;
}

.chart text {
  fill: black;
  font: 10px sans-serif;
  text-anchor: begin;
}

</style>
<script type="text/javascript">

// HACK -- they're described as bitmasks, but we treat them here as
// discrete values.
var colormap = { 1: "blue",
                 2: "steelblue",
                 4: "steelblue",
                 8: "steelblue",
                 16: "steelblue",
                 32: "black",
                 64: "black",
                 128: "black" };

var heightmap = {
    // Downstream
    1: 1,
    // Level 1
    2: 2,
    32: 2,
    // Level 2
    4: 3,
    64: 3,
    // Level 3
    8: 4,
    128: 4,
    // Level 4
    16: 5,
};

var margin = {top: 20, right: 30, bottom: 30, left: 40};
// width = 960 - margin.left - margin.right,
// height = 500 - margin.top - margin.bottom;
var width  = 800 - margin.left - margin.right;
var height = 200 - margin.top - margin.bottom;

var chartdata = {};

/*
  var xscale = d3.scaleLinear()
  .domain([0, 10])
  .range([0, width]);
  var xaxis = d3.axisBottom(xscale);
  */

var init_plot = function() {

    for (var i=0; i<1; i++) {

        var chart = d3.select('#node_chunks_' + i)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            //.attr("class", "chart main");
            //.attr("id", "node_margin_" + i);

        var chartbody = chart.append("g")
            .attr("class", "chart body");
            //.attr("id", "node_body_" + i);

        var xscale = d3.scaleLinear()
            .domain([0, 10])
            .range([0, width]);
        var xaxis = d3.axisBottom(xscale);

        var xaxisbox = chart.append("g")
            .attr("class", "xaxis")
            .attr("transform", "translate(0," + height + ")")
            .call(xaxis);
        //.attr("id", "node_xaxis_" + i)

        chartdata[i] = { 'xscale': xscale, 'xaxis': xaxis,
                         'body': chartbody, 'xaxisbox': xaxisbox };

    }

}

var loaded = function(result) {
    console.log('JSON loaded: ' + result);
    for (var i=0, len=result.length; i<len; i++) {
        node = result[i];
        console.log('node ' + node);
        $('#node_status_' + i).html(node['status']);

        ch = node['chunks'];

        // Show chunk numbers, not fpga counts.
        var Nchunk = 1024 * 400;

        var chunk_lo = [];
        var chunk_hi = [];
        var dchunk = []
        var chunk_range = []
        var chunk_where = [];
        for (var j=0; j<ch.length; j++) {
            var lo = ch[j][1] / Nchunk;
            var hi = ch[j][2] / Nchunk;
            var wh = ch[j][3];
            console.log('Chunk ' + lo + '+' + (hi-lo) + ' from ' + wh);
            chunk_where.push(wh);
            chunk_lo.push(lo);
            chunk_hi.push(hi);
            dchunk.push(hi - lo);
            chunk_range.push([lo, hi, wh]);
        }
        console.log('chunk lo: ' + chunk_lo);
        console.log('chunk hi: ' + chunk_hi);
        console.log('dchunk: ' + dchunk);

        var lolo = d3.min(chunk_lo);
        var hihi = d3.max(chunk_hi);

        console.log('overall range: ' + lolo + ' to ' + hihi);

        thischart = chartdata[i];

        /*
          var x = d3.scaleLinear()
          .domain([lolo, hihi])
          .range([0, width]);
          */
        thischart.xscale.domain([lolo, hihi]);

        var y = d3.scaleLinear()
            .domain([0, 6])
            .range([0, height]);

        var barHeight = y(1) - y(0);

        //var chart = d3.select('#node_chunks_' + i);

        //var chart = d3.select('#node_margin_' + i);
        
        //var chart = d3.select('#node_body_' + i);

        var chart = d3.select('#node_chunks_' + i);

        //var main = chart.select(".chart main");
        //var ax = main.select(".x.axis")
        thischart.xaxisbox
            .call(thischart.xaxis);

        //var body = chart.select(".chart body");
        var body = thischart.body;

        // General update pattern
        var bar = body.selectAll("g")
            .data(chunk_range);
        bar.exit().remove();
        var newbar = bar.enter().append("g");
        newbar.append("rect").style("fill", "green");
        newbar.append("text");
        var bar2 = newbar.merge(bar);

        bar2.attr("transform", function(d) {
            return "translate(" + thischart.xscale(d[0]) + "," +
                y(heightmap[d[2]]) + ")"; });

        var rect = bar2.select("rect")
            //.data(chunk_range)
            .attr("width", function(d) { console.log("Width: " + d[0] + ' to ' + d[1]); return thischart.xscale(d[1]) - thischart.xscale(d[0]); })
            .attr("height", barHeight - 1)
            .style("fill", function(d) { return colormap[d[2]]; });

        /*
        var rect = bar.append("rect")
            .data(chunk_range)
            .attr("width", function(d) { return x(d[1]) - x(d[0]); })
            .attr("height", barHeight - 1);

        var rect = bar.selectAll("rect")
            .data(chunk_range)
            .enter().append("rect")
            .attr("width", function(d) { return xscale(d[1]) - xscale(d[0]); })
            .attr("height", barHeight - 1)
            .style("fill", function(d) { return colormap[d[2]]; });

        rect.exit().remove();
            */

        //rect.data(chunk_where)
        //.style("fill", function(d) { return colormap[d]; });

        /*
        bar.append("text")
            .attr("x", 0)
            .attr("y", barHeight / 2)
            .attr("dy", ".35em")
            //.text(function(d) { return d[0] + "+" + (d[1]-d[0]); });
            .text(function(d) { return d[0]; });
        */

        bar2.select("text")
            .attr("x", 0)
            .attr("y", barHeight / 2)
            .attr("dy", ".35em")
            //.text(function(d) { return d[0] + "+" + (d[1]-d[0]); });
            .text(function(d) { return d[0]; });


        /*
        var axis = d3.axisBottom(x);
        var ax = chart.selectAll("#node_xaxis_" + i);
        ax.remove();
        ax.call(axis);
        */
        //var axis = d3.axisBottom(xscale);
        //var ax = chart.select("#node_xaxis_" + i)

        /*
        var ax = chart.selectAll("#node_xaxis_" + i)
            //.attr("transform", "translate(0," + height + ")")
            .call(axis);
            */

        /*
        var ax = chart.append("g")
            .attr("class", "x-axis")
            .attr("id", "node_xaxis_' + i)
            .attr("transform", "translate(0," + height + ")")
            .call(axis);
        */

        setTimeout(load_status, 3000);
    }
  };

  $(document).ready(function() {
      init_plot();

      load_status();
      //setTimeout(fake_loaded, 1000);
  });

  var load_status = function() {
    $.getJSON('{{ node_status_url }}', loaded);
  };

  var fake_loaded = function() {
      var Nchunk = 1024 * 400;

      result = [{'chunks': [
          [ 77,  0*Nchunk,  8*Nchunk, 16],
          [ 77,  8*Nchunk, 16*Nchunk, 16],
          [ 77, 16*Nchunk, 24*Nchunk, 16],
      ]}];
      loaded(result);

      setTimeout(fake_loaded_2, 1000);
  };

  var fake_loaded_2 = function() {
      var Nchunk = 1024 * 400;

      result = [{'chunks': [
          [ 77,  0*Nchunk,  8*Nchunk, 16],
          [ 77,  8*Nchunk, 16*Nchunk, 16],
          [ 77, 16*Nchunk, 24*Nchunk, 16],
          [ 77, 24*Nchunk, 32*Nchunk, 16],
      ]}];
      loaded(result);

      setTimeout(fake_loaded_3, 1000);
  };

  var fake_loaded_3 = function() {
      var Nchunk = 1024 * 400;

      result = [{'chunks': [
          [ 77,  8*Nchunk, 16*Nchunk, 16],
          [ 77, 16*Nchunk, 24*Nchunk, 16],
          [ 77, 24*Nchunk, 32*Nchunk, 16],
      ]}];
      loaded(result);
  };


</script>

<h3>CHIME FRB L1 node status</h3>

{% for i,node in nodes %}
<div>
  <p>{{ node }}</p>
  <div id="node_status_{{i}}"></div>
  <svg class="chart" id="node_chunks_{{i}}" /></div>
</div>
{% endfor %}

</body>
</html>
